## error处理

业务层统一使用 infra/errors包  (极客时间go项目实战搬过来的), 具体使用可以看 infra/errors/README.md

在`https://github.com/marmotedu/errors`

核心是把业务错误码和error关联起来了。 这样的好处是控制器无须关心哪个错误，直接在响应的时候，传入这个错误，那么就知道是哪个业务code错误码。

错误处理，必须层层上抛，直到最高层，再去处理error。


- http服务：
  model返回error ->  service error -> controller 中的err 然后 响应处理，响应的时候会判断是否err !=nil ，有错误会记录到gin的上下文中，
  最终通过logger中间件把这个错误信息给记录到log中。 

  
控制器中的代码
```go
/**
* @Author: cr-mao
* @Desc:
**/
package controllers

import (
	"github.com/gin-gonic/gin"
	"goframe/app"
	"goframe/app/http/requests"
	"goframe/app/http/response"
)

type UserController struct{}

// 用户信息
func (c *UserController) UserInfo(ctx *gin.Context) {
	var req requests.UserInfoRequest
	if ok := requests.Validate(ctx, &req, requests.UserInfoValid); !ok {
		return
	}
	userService := app.UserService()
	userInfo, err := userService.GetUserInfo(ctx, 1)
	response.WriteResponse(ctx, err, userInfo)
}

```

service中的代码
```go
// GetUserInfo
//
//	@Description:  用户信息
//	@receiver s
//	@param ctx
//	@param userId
//	@return *dto.UserDto  返回数据
//	@return error
func (s *UserService) GetUserInfo(ctx context.Context, userId int64) (*dto.UserDto, error) {
	session := db.Client(ctx, global.DB_NBGAMETASK)
	userRow := tuser_model.GetByUserId(session, userId)
	if userRow.Fid == 0 {
		return nil, errors.WithCode(errcode.ErrUserNotFound, "user not found userId:%d", userId)
	}
	var res dto.UserDto
	res.Fuserid = userRow.Fid
	res.Fname = userRow.Fname
	return &res, nil
}
```


```text
func WriteResponse(c *gin.Context, err error, data interface{}) {
	if err != nil {
		// 错误的堆栈详细信息，
		errStr := fmt.Sprintf("%#+v", err)
		// 通过上下文注入错误堆栈
		c.Set("error_detail", errStr)
		coder := errors.ParseCoder(err)
		c.JSON(coder.HTTPStatus(), Response{
			ErrorCode: coder.Code(),
			Msg:       coder.String(),
			Data:      nil,
		})
		return
	}
	c.JSON(http.StatusOK, data)
}
```

log中的errors错误展, 能知道路径，能知道错误的具体行数，已经能够很快定位到具体代码了
```text
{"level":"ERROR","time":"2024-04-14 22:59:05","caller":"middlewares/logger.go:70","message":"HTTP Error 400","status":400,"request_uri":"/api/v1/user_info","cost_time":54,"ip":"127.0.0.1","user-agent":"PostmanRuntime/7.29.0","errors":"[{\"caller\":\"#0 /Users/edgar/Documents/www/goframe/app/services/user_service/user_service.go:39 (goframe/app/services/user_service.(*UserService).GetUserInfo)\",\"code\":10010101,\"error\":\"user not found 1\",\"message\":\"用户没找到\"}]","body":"{\n    \"user_id\":1,\n    \"user_name\":\"maozhon\,"response":"{\"error_code\":10010101,\"msg\":\"用户没找到\",\"data\":null}","stacktrace":"goframe/app/http/routers.registerGlobalMiddleWare.Logger.func1\n\t/Users/edgar/Documents/mq/app/http/middlewares/logger.go:70\ngithub.com/gin-gonic/gin.(*Context).Next\n\t/Users/edgar/go1.21.7path/pkg/mod/github.com/gin-gonic/gin@v1.9.1/context.go:174\ngithub.com/gin-gonic/gin.(*Engine).handleHTTPRequest\n\t/Users/edgar/go1.21.7path/pkg/mod/github.com/gin-gonic/gin@v1.9.1/gin.go:620\ngithub.com/gin-gonic/gin.(*Engine).ServeHTTP\n\t/Users/edgar/go1.21.7path/pkg/mod/github.com/gin-gonic/gin@v1.9.1/gin.go:576\nnet/http.serverHandler.ServeHTTP\n\t/Users/edgar/go1.21.7/src/net/http/server.go:2938\nnet/http.(*conn).serve\n\t/Users/edgar/go1.21.7/src/net/http/server.go:2009"}
```


wrap error使用
见error_controller.Demo1

```shell 
{"level":"ERROR","time":"2024-04-16 08:54:07","caller":"middlewares/logger.go:66",
"message":"HTTP Error 400","status":400,"request_uri":"/api/v1/test_error_demo1",
"cost_time":0,"ip":"127.0.0.1","user-agent":"PostmanRuntime/7.29.0",
"errors":"[{\"caller\":\"#1 /Users/edgar/Documents/www/goframe/app/services/error_service/error_service.go:23 (goframe/app/services/error_service.(*ErrorService).Demo1)\",\"code\":10010102,\"error\":\"ErrorService demo1 get error\",\"message\":\"用户无效\"},{\"caller\":\"#0 /Users/edgar/Documents/www/goframe/services/error_service/error_service.go:19 (goframe/app/services/error_service.init)\",\"code\":1,\"error\":\"demo error\",\"message\":\"demo error\"}]","body":"{\n    \"user_id\":1,\n    \"user_name\":\"maozhon\"\n}","response":"{\"error_code\":10010102,\"msg\":\"用户无效\",\"data\":null}",
"stacktrace":"goframe/app/http/routers.registerGlobalMiddleWare.Logfunc1\n\t/Users/edgar/Documents/www/goframe/app/http/middlewares/logger.go:66\ngithub.com/gin-gonic/gin.(*Context).Next\n\t/Users/edgar/go1.21.7path/pkg/mod/github.com/gin-gonic/gin@v1.9.1/context.go:174\ngithub.com/gin-gonic/gin.(*Engine).handleHTTPRequest\n\t/Users/edgar/go1.21.7path/pkg/mod/github.com/gin-gonic/gin@v1.9.1/gin.go:620\ngithub.com/gin-gonic/gin.(*Engine).ServeHTTP\n\t/Users/edgar/go1.21.7path/pkg/mod/github.com/gin-gonic/gin@v1.9.1/gin.go:576\nnet/http.serverHandler.ServeHTTP\n\t/Users/edgar/go1.21.7/src/net/http/server.go:2938\nnet/http.(*conn).serve\n\t/Users/edgar/go1.21.7/src/net/http/server.go:2009"}
```


- cmd 服务, 一层层往上抛，直到入口cmd处进行error 日志处理。


Notice:
- 业务代码处，禁止手动写panic，然捕获，panic并非php中的exception。



